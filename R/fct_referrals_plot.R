#' Referrals Plot Data
#'
#' Prepares the data for \code{referrals_plot()}
#'
#' @param model_output output from \code{run_model()} and \code{get_model_output()}
#' @param treatment a name of a treatment to filter by
#'
#' @return a summarised version of \code{model_output}
#'
#' @importFrom dplyr %>%
referrals_plot_data <- function(model_output, treatment) {
  model_output %>%
    summarise_model_output("new-referral", treatment)
}

#' Referrals Plot
#'
#' Generates a plot that shows the referrals generated by the model.
#'
#' @param model_output output from \code{run_model()} and \code{get_model_output()}
#' @param treatment a name of a treatment to filter by
#'
#' @return a plotly chart
#'
#' @importFrom dplyr %>%
#' @importFrom plotly plot_ly layout config
referrals_plot <- function(model_output, treatment) {
  df <- referrals_plot_data(model_output, treatment)

  if (nrow(df) < 1) return(NULL)

  plot_ly(df,
          type = "scatter",
          mode = "lines",
          x = ~date,
          y = ~value,
          hovertext = NULL,
          hovertemplate = paste("<b>Month</b>: %{x}",
                                "<b>Referrals</b>: %{y:.0f}",
                                "<extra></extra>",
                                sep = "<br>")) %>%
    layout(showlegend = FALSE,
           xaxis = list(title = "Month"),
           yaxis = list(title = "New Referrals")) %>%
    config(displayModeBar = FALSE)
}

#' @rdname referrals_plot
#' @import ggplot2
#' @return a ggplot2 chart
referrals_plot_ggplot <- function(model_output, treatment) {
  df <- referrals_plot_data(model_output, treatment)

  if (nrow(df) < 1) return(NULL)

  df %>%
    ggplot(aes(.data$date, .data$value)) +
    theme_bw() +
    geom_line(colour = "red") +
    scale_x_date(name = "Month",
                 date_breaks = "3 months",
                 date_labels =  "%b %Y") +
    labs(y = "New Referrals",
         title = "Additional Patients Receiving Service")
}
