---
output: 
  pdf_document:
    toc: true
papersize: a4
classoption: landscape
geometry: margin=1in
title: "\\vspace{-3cm} Modelled Results by Service"
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(tibble)
library(patchwork)
library(gridExtra)
library(grid)

# model_output, appointments and demand should be set in the environment before running this report
stopifnot("model_output does not exist" = exists("model_output"),
          "params does not exist" = exists("params"),
          "services does not exist" = exists("services"))

# you can recreate these variables using the code below. Note: this is the model params, not the Rmd params
# model_output <- get_model_output(models)
# services <- names(params$treatments)

appointments <- get_appointments(params)
```

```{r, echo=FALSE, message=FALSE, results="asis", fig.width=18, fig.height=11}
purrr::walk(services, function(service) {
  cat("# ", service, "\n\n", sep = "")

  a <- referrals_plot_ggplot(model_output, service)
  
  b <- demand_plot_ggplot(model_output, appointments, service)
  
  c <- tableGrob(
    tribble(
      ~ Metric, ~ Number,
      "Total 'surge' Referrals", model_totals(model_output, "new-referral", service),
      "Total new patients in service", model_totals(model_output, "treatment", service),
      # "Total additional demand per contact type", model_totals(model_output, "new-treatment", service),
    ),
    rows = NULL,
    cols = NULL,
    theme = ttheme_default(
      core = list(
        fg_params = list(
          hjust = 0, x = 0
        )
      )
    )
  )
  
  d <- model_output %>%
    popgroups_plot_data(service) %>%
    rename(Group = group) %>%
    tableGrob(rows = NULL)
  
  e <- combined_plot_ggplot(model_output, service, params)
  
  p <- (a | b) / (wrap_elements(c) | wrap_elements(d) | e) ## c and d needs to be made patchwork compliant

  plot(p)
  cat("\n\n")
})
```
